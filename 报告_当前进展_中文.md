# ROSMAP Cellpose-SAM 微调项目：当前进展重汇报（中文）

更新时间：`2026-02-09 23:09 EST`  
仓库：`/ihome/jbwang/liy121/finetune`（软链接到 `/ix/jbwang/liangyou/fintune`）

## 0. 当前执行约束（已落实）
1. 全部任务走 Slurm 上传，不在本地直接跑实验。  
2. 统一使用 GPU（`CellposeModel(gpu=True)`），分区使用 `l40s`。  
3. E5 只使用本仓库 `finetune/` 下数据与代码，不再引用外部 donor 聚合表。  

---

## 1. 项目目标与你论文主线对应
1. `E1`：证明 fine-tune 比 off-the-shelf baseline 分割更好（AP/Precision/Recall/F1）。  
2. `E2`：证明 label-efficient（低标注预算也能显著提升）。  
3. `E3`：证明后处理主要作用是控制 FP / 提升 precision。  
4. `E4`：诊断自动提示/参数敏感性（目前是 cpsam proxy sweep）。  
5. `E5`：证明“分割改进 -> donor-level 下游相关性与稳定性更可靠”。  

---

## 2. 数据输入输出口径（统一）

### 2.1 训练/评估数据
- 数据目录：`data/cellpose/`  
- split（donor-level）：
  - `train_cells`: 72 图 + 72 mask
  - `val_cells`: 24 图 + 24 mask
  - `test_cells`: 24 图 + 24 mask
- donor split 文件：`data/splits/donor_splits.yaml`

### 2.2 模型输入
- 标准输入是 3 通道：`[DAPI, marker, 0]`。  
- `marker-only` 对照通过 `--zero-dapi` 将第 0 通道强制置零。

### 2.3 模型输出
- 实例分割 mask：`uint16/int32`，0 为背景，1..N 为实例 id。  
- 评估指标：AP@0.5、Precision、Recall、F1（按 TP/FP/FN 统一计算）。

### 2.4 E5 donor-level 定义
- tile 级统计：
  - `n_total_cells`
  - `n_marker_positive`（实例内 marker 均值 > 该 tile marker 强度分位数阈值，默认 75）
  - `ratio = n_marker_positive / n_total_cells`
  - `total_density_mpx = n_total_cells / area_px * 1e6`
  - `pos_density_mpx = n_marker_positive / area_px * 1e6`
- donor 级：对 tile 累加后再计算 ratio/density。

---

## 3. 代码与脚本结构（你现在实际在用）
- 数据准备：`scripts/prepare_cellpose_data.py` / `src/fintune/data_prep/prepare_cellpose_data.py`  
- 训练：`scripts/train_finetune_generic.py`、`scripts/train_finetune_gfap.py`  
- baseline/评估：`scripts/run_cpsam_baseline.py`  
- E1 阈值扫：`scripts/run_e1_threshold_sweep.py`  
- E2：`scripts/run_budget_curve.py`  
- E3（Val 选参 -> Test 一次）：`scripts/run_e3_val_select_test.py`  
- E4：`scripts/run_microsam_sweep.py`（当前为 cpsam proxy）  
- E5 推理：`scripts/run_full_inference.py` / `src/fintune/inference/full_inference.py`  
- E5 下游：`scripts/analyze_downstream.py` / `src/fintune/evaluation/downstream.py`  
- Slurm：`slurm/*.sbatch`

---

## 4. E1 主实验进展（已完成 + 在跑）

### 4.1 E1.1 Baseline（已完成）
- 作业：`1593585`（`slurm/e1_baseline_test.sbatch`）  
- 参数：`model=cpsam`, `split=test`, `flow=0.4`, `cellprob=0.0`  
- 输出：`data/predictions/cpsam/test/metrics.json`

test overall：
- AP50 `0.1065`
- Precision `0.0982`
- Recall `0.7873`
- F1 `0.1746`

### 4.2 E1.2 Generic fine-tune（已完成）
- 作业：`1593586`（`slurm/e1_generic_train_eval.sbatch`）  
- 训练参数：`epochs=80, lr=1e-4, batch=2, nimg_per_epoch=72, nimg_test_per_epoch=24`  
- 模型：`data/checkpoints/generic_cpsam/models/generic_cpsam`  
- 输出：`data/predictions/generic_cpsam/test/metrics.json`

test overall：
- AP50 `0.6740`
- Precision `0.8430`
- Recall `0.8312`
- F1 `0.8370`

### 4.3 E1.3 GFAP-specific（已完成）
- 作业：`1593587`（`slurm/e1_gfap_train_eval.sbatch`）  
- 参数：`epochs=80, lr=1e-4, batch=2, nimg_per_epoch=18, nimg_test_per_epoch=6`  
- 输出：`data/predictions/gfap_cpsam/test/metrics.json`

test overall：
- AP50 `0.3732`
- Precision `0.7157`
- Recall `0.4179`
- F1 `0.5277`

### 4.4 E1.4 Marker-only（已完成）
- 作业：`1593588`（`slurm/e1_marker_only_train_eval.sbatch`）  
- 参数：同 generic 训练轮次，额外 `--zero-dapi`  
- 输出：
  - `data/predictions/marker_only_cpsam/val/metrics.json`
  - `data/predictions/marker_only_cpsam/test/metrics.json`

test overall：
- AP50 `0.5152`
- Precision `0.8401`
- Recall `0.6716`
- F1 `0.7465`

### 4.5 E1.5 阈值 sweep（已完成）
- 作业：`1593589`（`slurm/e1_threshold_sweep.sbatch`，`COMPLETED`）  
- 网格：`3(flow) x 5(cellprob)=15` 组合/模型  
- 模型数：4（baseline/generic/gfap/marker_only）  
- 总评估次数：`60 (val)` + `4 (test 固定阈值)`

当前已落盘：
- `data/reports/e1_threshold_sweep_baseline_val.tsv`
- `data/reports/e1_threshold_sweep_generic_val.tsv`
- `data/reports/e1_threshold_sweep_gfap_val.tsv`
- `data/reports/e1_threshold_sweep_marker_only_val.tsv`
- `data/reports/e1_threshold_selected_test.tsv`
- `data/predictions/baseline_thsel/test/metrics.json`
- `data/predictions/generic_thsel/test/metrics.json`
- `data/predictions/gfap_thsel/test/metrics.json`
- `data/predictions/marker_only_thsel/test/metrics.json`

当前 best（按 val F1）：
- baseline: `flow=0.2, cellprob=-1.0, val_f1=0.2146`  
  - test(thsel): AP50 `0.1363`, P `0.1313`, R `0.7183`, F1 `0.2220`
- generic: `flow=0.4, cellprob=-1.0, val_f1=0.8309`  
  - test(thsel): AP50 `0.7040`, P `0.8042`, R `0.8890`, F1 `0.8445`
- gfap: `flow=0.6, cellprob=-1.0, val_f1=0.4792`  
  - test(thsel): AP50 `0.4889`, P `0.7217`, R `0.6119`, F1 `0.6623`
- marker_only: `flow=0.4, cellprob=-1.0, val_f1=0.7941`  
  - test(thsel): AP50 `0.6197`, P `0.8230`, R `0.7938`, F1 `0.8082`

---

## 5. E2 Label Efficiency（本轮已完成）
- 作业：`1593590`（`slurm/e2_budget_curve_force_rerun.sbatch`）  
- 状态：`COMPLETED`（sacct）  
- 设计：budgets=`[2,5,10,20,30]`，repeats=`5`，共 `25` 次训练+评估  
- 参数：`epochs=6, lr=1e-4, batch=2, eval_split=val`  
- 实验目录：`data/logs/budget_curve_long_e6_force_gpu/`

完成情况：
- run 目录总数：`25`
- `metrics.json`：`25/25` 全部落盘
- 汇总文件：
  - `data/logs/budget_curve_long_e6_force_gpu/records.tsv`（26 行，含表头）
  - `data/logs/budget_curve_long_e6_force_gpu/summary.json`

当前 budget AP50 均值（val）：
- b2: `0.0530`
- b5: `0.1322`
- b10: `0.1765`
- b20: `0.4150`
- b30: `0.4003`

结论：低预算到中预算显著上升，20 后趋于平台；30 与 20 接近。

---

## 6. E3 Gating 消融（已完成，且无 Test 泄漏）
- 作业：`1593591`（`slurm/e3_gating_sweep_force_rerun.sbatch`）  
- 脚本：`scripts/run_e3_val_select_test.py`  
- 规则：只在 Val 网格选最优，再在 Test 固定一次。

网格规模：
- `q_low={0.0,0.02,0.05}`
- `q_high={1.0,0.98,0.95}`
- `min_area={50,60,80}`
- 有效组合：`27` 个 Val 组合 + `1` 个 Test 最终评估。

结果文件：
- `data/reports/e3_gating_val_grid_generic_cpsam.tsv`
- `data/reports/e3_gating_test_final_generic_cpsam.tsv`
- 最终 test 详表：`data/reports/e3_gating_generic_cpsam_test_q0_100_a50.tsv`

选中参数：`q_low=0.0, q_high=1.0, min_area=50`。  
Test overall：raw F1 `0.8370` -> gated F1 `0.8376`（`+0.0006`）。

---

## 7. E4 微诊断（作业完成，但产物当前缺失）
- 作业：`1593592`（`slurm/e4_microsam_sweep.sbatch`）  
- 参数：`points_per_side=16/32/64`, `num_tiles=10`, `seed=2024`  
- 日志显示 sampled：`24` tiles。

日志显示已保存到：
- `data/reports/microsam/e4_microsam_proxy_sweep_n10_seed2024.tsv`
- `data/reports/microsam/e4_microsam_proxy_sweep_n10_seed2024.json`

当前文件系统中这两份文件不存在。  
状态：若要用于最终图表，需要补跑 E4 或恢复该目录。

---

## 8. E5 下游（正在跑，已完成覆盖审计）

### 8.1 你要求的“重头计算”已落地到代码
- `src/fintune/inference/full_inference.py`
- `src/fintune/evaluation/downstream.py`

关键实现点：
1. tile pairing 从 `data/rosmap` 自动发现 `c0-c1`，并支持 `c2` fallback。  
2. donor 解析改为正则提取数字 ID。  
3. 输出 tile 级 + donor 级 ratio/density，不依赖外部 donor 聚合 CSV。  
4. 下游直接读取 `data/ROSMAP_clinical_n69.csv`。  
5. 结局变量覆盖：`braaksc, ceradsc, cogdx, dcfdx_lv, plaq_d, plaq_n, nft, gpath`。  
6. 统计：Spearman + BH-FDR + tile bootstrap 稳定性。

### 8.2 已完成：覆盖审计
- 作业：`1593593`  
- 结果：`data/reports/e5_coverage_audit.json`

审计关键数字：
- paired tiles: `14758`
- `c2` fallback 使用数: `1148`
- tile donor 数：`71`
- clinical donor 数：`69`
- clinical 外 donor：`11319359`, `11345321`
- marker tile counts:
  - gfap `2947`
  - iba1 `3064`
  - neun `2837`
  - olig2 `2978`
  - pecam `2932`

### 8.3 正在跑的 E5 主任务
- `1593594`: `slurm/e5_downstream_compare.sbatch`
  - 流程：全量推理 baseline+finetuned -> 下游 Spearman/FDR/bootstrap
  - 目标输出：
    - `data/downstream/full_inference/baseline/tile_counts.tsv`
    - `data/downstream/full_inference/finetuned/tile_counts.tsv`
    - `data/downstream/e5_spearman.tsv`
    - `data/downstream/e5_bootstrap_stability.tsv`
    - `data/downstream/e5_summary.json`
- `1593595`: `slurm/e5_threshold_sensitivity.sbatch`
  - 百分位阈值：`60 70 75 80 90`
  - bootstrap=`100`
  - 目标：阈值敏感性稳定性报告

当前状态：两个 E5 作业都仍在运行；`data/downstream/full_inference/` 尚未出现最终表文件。

---

## 9. E6（额外实验）
- 作业阵列：`1593596_0~3` 显示完成。  
- 日志中可见 heldout 指标：
  - gfap: AP50 `0.3610`, F1 `0.5290`
  - iba1: AP50 `0.5743`, F1 `0.7174`
  - neun: AP50 `0.1373`, F1 `0.2518`
  - olig2: AP50 `0.6102`, F1 `0.7660`

注意：`data/reports/e6_lomo_*.tsv` 与 `data/checkpoints/lomo_excl_*` 当前不在文件系统（此前清理后未保留）。  
若要入文，需要重跑或恢复产物。

---

## 10. 数据增强到底有没有做（明确回答）
有。  
训练调用 `cellpose.train.train_seg`，其内部默认执行 `random_rotate_and_resize(...)`（随机旋转/缩放裁块），`scale_range` 默认 `0.5`。  
当前代码未关闭此默认增强，因此 E1/E2/E6 训练包含 Cellpose 内建增强。

---

## 11. 当前正在跑的作业（实时）
（查询时刻：报告更新时间）
1. `1593594` `e5_downstream` `RUNNING`（`l40s`，GPU 1）  
2. `1593595` `e5_thresh_sens` `RUNNING`（`l40s`，GPU 1）

`1593589 (E1.5)` 与 `1593590 (E2)` 已完成，不再占用队列。

---

## 12. 总结：完成度与缺口

### 已闭环（有代码 + 有输出）
- E0
- E1.1 / E1.2 / E1.3 / E1.4 / E1.5
- E2（本轮 force rerun 完整 25/25）
- E3
- E5 覆盖审计

### 进行中
- E5 主下游与阈值敏感性（核心结果待落盘）

### 需补齐产物
- E4 proxy sweep 文件当前不在 `data/reports/microsam/`（需补跑/恢复）
- E6 文件被清理，若要写进论文需重新产出持久文件

---

## 13. 论文写作可直接引用的当前结论（到此刻）
1. generic fine-tune 相比 baseline 的 test 指标提升显著（AP50/F1/Precision/Recall 同时提升）。  
2. marker-only 低于 generic，支持“DAPI 信息有增益”。  
3. E2 已完成并显示 2->20 预算显著上升，20 后趋于平台。  
4. E3 显示在当前强模型上，gating 增益很小（更多是稳健性细调）。  
5. E5 已按你的要求重构为“从 tile 重算 donor 特征 + 临床相关 + bootstrap 稳定性”，当前在等两个 E5 作业落盘最终结果。
