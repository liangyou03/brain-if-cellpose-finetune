# ROSMAP Cellpose-SAM 微调项目：当前完整进展报告（细节版）

更新时间：2026-02-09（集群本地时间）

## 1. 项目目标和实验结构（E0-E5）
本项目目标是构建并验证一条从分割到下游分析的完整链路：
- E0：数据整理（donor split + Cellpose格式）
- E1：分割主实验（baseline / fine-tune / marker-specific / marker-only）
- E2：标注预算效率曲线（label efficiency）
- E3：推理后处理消融（gating）
- E4：micro-sam / muSAM 诊断
- E5：ROSMAP 下游价值（donor-level 相关性 + 稳定性）

代码分层：
- `src/fintune/data_prep`：E0
- `src/fintune/training`：E1/E2
- `src/fintune/inference`：E1 baseline、E4、E5全量推理
- `src/fintune/evaluation`：E3、E5统计
- `scripts`：命令行入口
- `slurm`：集群任务脚本（l40s）

---

## 2. 我实际做了哪些代码工作（按模块）
## 2.1 把核心流程从 stub 改成可运行
已实现/重写：
- `src/fintune/data_prep/prepare_cellpose_data.py`
- `src/fintune/inference/cpsam_baseline.py`
- `src/fintune/training/finetune_generic.py`
- `src/fintune/training/finetune_gfap.py`
- `src/fintune/training/budget_curve.py`
- `src/fintune/evaluation/gating_ablation.py`

新增通用工具：
- `src/fintune/utils/dataset.py`
- `src/fintune/utils/metrics.py`

同步更新入口脚本参数：
- `scripts/run_cpsam_baseline.py`
- `scripts/train_finetune_generic.py`
- `scripts/train_finetune_gfap.py`
- `scripts/run_budget_curve.py`
- `scripts/run_gating_ablation.py`

## 2.2 新增和强化的实验脚本
新增/调整：
- `scripts/run_microsam_sweep.py`
- `scripts/run_full_inference.py`（已重写）
- `scripts/analyze_downstream.py`（已重写）
- `slurm/e1_marker_only_train_eval.sbatch`
- `slurm/e4_microsam_sweep.sbatch`
- `slurm/e5_downstream_compare.sbatch`

## 2.3 可恢复性/断点续跑
- E2 budget curve 支持 `--skip-existing`，可以跳过已完成组合。
- 预算输出增加时间戳文件，避免覆盖。
- E5 full inference 在代码中支持 `resume` 模式（从已有 tile_counts 继续）。

---

## 3. 数据输入输出协议（非常关键）
## 3.1 E0 输入输出
输入：ROSMAP IF 标注图像（DAPI + marker）。
输出：
- `data/cellpose/train_cells`
- `data/cellpose/val_cells`
- `data/cellpose/test_cells`

格式约定：
- 图像 3 通道：`[DAPI, marker, 0]`
- mask：实例分割（0背景，1..N实例）

当前切分：train=72, val=24, test=24。

## 3.2 E1/E4/E5 模型输入输出
输入：tif/tiff tile。
- 通道映射按 Cellpose 调用 `channels=[1,2]`。

输出：
- 预测 mask：`*_pred.tif`
- 指标：`metrics.json`（AP50、P、R、F1、TP/FP/FN）

## 3.3 E5（新版本）输入输出
你要求“不要用外部聚合表，必须自己算比例”，已按这个方向重构：

E5.1 full inference 输出（目标路径）：
- `data/downstream/full_inference/baseline/tile_counts.tsv`
- `data/downstream/full_inference/finetuned/tile_counts.tsv`
- `data/downstream/full_inference/tile_counts_all.tsv`
- `data/downstream/full_inference/donor_marker_ratio.tsv`

E5.2/5.3 downstream 输出：
- `data/downstream/e5_donor_marker_ratio_from_tiles.tsv`
- `data/downstream/e5_spearman.tsv`
- `data/downstream/e5_bootstrap_stability.tsv`
- `data/downstream/e5_summary.json`

临床表输入：
- `data/ROSMAP_clinical_n69.csv`

结局变量（按你要求）：
- `braaksc, ceradsc, cogdx, dcfdx_lv, plaq_d, plaq_n, nft, gpath`

---

## 4. 已完成实验与结果
## 4.1 E1 主实验（已完成）
关键文件：
- `data/reports/e1_metrics_all_models.tsv`
- `data/reports/e1_metrics_with_hybrid.tsv`
- `data/reports/e1_generic_vs_baseline_delta.tsv`

test overall（当前主要结果）：
- baseline (`cpsam`): AP50=0.1062, P=0.0981, R=0.7864, F1=0.1744
- generic (`generic_cpsam`): AP50=0.2359, P=0.5009, R=0.5261, F1=0.5132
- gfap-specific (`gfap_cpsam`): AP50=0.1493, P=0.2364, R=0.6185, F1=0.3420
- hybrid: AP50=0.2580, P=0.4639, R=0.5700, F1=0.5115

结论：
- generic 显著提升 precision/F1；
- OLIG2 在 generic 下失效明显；
- hybrid 通过混合策略提升了 AP50。

## 4.2 E1.4 marker-only（已完成）
模型：`marker_only_cpsam`（训练和推理均 zero-DAPI）。
输出：
- `data/predictions/marker_only_cpsam/val/metrics.json`
- `data/predictions/marker_only_cpsam/test/metrics.json`

test overall：
- AP50=0.0899, P=0.4863, R=0.2659, F1=0.3438

结论：
- precision 尚可，但 recall 大幅下降；
- IBA1/OLIG2 近乎失效；
- 说明 DAPI 信息对本任务仍然重要。

## 4.3 E2 label efficiency（已完成）
主要输出：
- `data/logs/budget_curve_long_e6/records.tsv`
- `data/logs/budget_curve_long_e6/summary.json`
- `data/reports/e2_budget_all_runs.tsv`
- `data/reports/e2_budget_summary_final.tsv`

long run summary（overall AP50 mean）：
- budget 2: 0.0623
- budget 5: 0.1439
- budget 10: 0.2324
- budget 20: 0.3970
- budget 30: 0.4044

结论：
- 2->20 提升明显；20->30趋于平台。

## 4.4 E3 gating ablation（已完成）
输出：
- `data/reports/e3_gating_generic_cpsam_test_q0_100_a50.tsv`
- `data/reports/e3_gating_generic_cpsam_test_q2_98_a60.tsv`
- `data/reports/e3_gating_generic_cpsam_test_q5_95_a80.tsv`

结论：
- `q0_100 + min_area=50` 最稳，带来轻微 precision/F1 改善。

## 4.5 E4（已完成 proxy 版本）
输出：
- `data/reports/microsam/e4_microsam_proxy_sweep_n10_seed2024.tsv`
- `data/reports/microsam/e4_microsam_proxy_sweep_n10_seed2024.json`

说明：
- 当前是 cpsam proxy sweep，不是原生 micro-sam。
- pps=64 的 AP/F1 在测试设置中最高。

---

## 5. E5 当前状态（重点）
## 5.1 重构情况
已完成重构：
- `src/fintune/inference/full_inference.py`
  - 自动搜索 c0/c1 channel tile 对；
  - 同时跑 baseline 与 finetuned；
  - 导出 tile-level count 和 donor-level ratio。
- `src/fintune/evaluation/downstream.py`
  - 只从 full_inference 输出计算 donor ratio；
  - Spearman + BH-FDR；
  - tile-bootstrap 稳定性（每 donor 80% tiles，重复 N 次）。

## 5.2 失败与修复记录
- 作业 `1593418` 失败原因：误读取 `*_metadata.xml` 为 tiff。
- 修复已提交：
  - 仅接受 `.tif/.tiff`；
  - 单 tile 读失败时跳过（不整任务崩溃）。
- 重试作业：`1593498`（l40s, 24h）正在执行链路。

## 5.3 当前是否完成
- 代码层面：E5 新链路已实现。
- 运行层面：最终生产输出尚未完全确认（`full_inference` 目录当前仅见部分结构）。
- 因此 E5 定义为：**进行中**。

---

## 6. 集群作业记录（近期）
已完成：
- `1593407`：E1 marker-only
- `1593408`：E5旧版
- `1593409`：E4 proxy
- `1593418`：E5尝试（失败）

当前重试：
- `1593498`：E5（full inference + downstream）

---

## 7. 你最关心的问题：我到底做了什么
简述：
1) 我把 E0-E4 做成了可运行、可复现并且有结果文件的流水线。  
2) 我把 E5 从“读已有聚合表”重构为“从 tile 级计数自己算 donor 比例再做相关性/稳定性”。  
3) 我把 marker-only 对照（E1.4）补齐并得到完整 test 指标。  
4) 当前剩余核心工作就是等 E5 新链路作业跑完并验证产出，然后出最终总表。

---

## 8. 下一步（执行顺序）
1. 监控 `1593498`，确认四类产物完整落盘：
   - baseline tile_counts
   - finetuned tile_counts
   - donor_marker_ratio
   - 新版 e5_spearman / e5_bootstrap_stability
2. 生成最终总报告（E1/E2/E3/E4/E5整合表）。
3. 若 E5 仍有异常，优先保留 full_inference 中间结果并做断点续跑，不重复全量。

